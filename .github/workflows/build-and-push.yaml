name: Build and push
on:
  pull_request:
    branches:
      - "main"
    paths:
      - src/**
  push:
    branches:
      - "main"
    paths:
      - src/**
      - ".github/**"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  GAR_ADDRESS: europe-docker.pkg.dev
  NAMESPACE: easytrade
  REGISTRY: ghcr.io/arctiqdynatracedemo/easytrade
  PACKAGE_BASE: arctiqdynatracedemo/easytrade
  HELM_REGISTRY: oci://ghcr.io/arctiqdynatracedemo/easytrade/helm
  HELM_CHART_PATH: helm/easytrade

jobs:
  prepare:
    runs-on: ubuntu-24.04
    outputs:
      images: ${{ steps.retrieve-images.outputs.images }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute SemVer from release-please manifest (PR branch, else main)
        id: version
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          sha_short="$(echo "${GITHUB_SHA}" | cut -c1-8)"

          # Manifest key to read. For monorepos, change "." to "packages/your-service" etc.
          manifest_key="."

          # Find the open release-please PR (default label)
          pr_json="$(gh pr list --state open --label "autorelease: pending" --limit 1 --json headRefName)"
          head_ref="$(echo "$pr_json" | jq -r '.[0].headRefName // empty')"

          if [[ -n "$head_ref" ]]; then
            # Read manifest from release-please PR branch
            git fetch origin "${head_ref}:${head_ref}" --force >/dev/null
            base="$(git show "${head_ref}:.release-please-manifest.json" | jq -r --arg k "$manifest_key" '.[$k]')"
            source="release-please PR branch (${head_ref})"
          else
            # Fallback: read manifest from main
            git fetch origin main:main --force >/dev/null
            base="$(git show "main:.release-please-manifest.json" | jq -r --arg k "$manifest_key" '.[$k]')"
            source="main branch"
          fi

          if [[ -z "$base" || "$base" == "null" ]]; then
            echo "ERROR: Could not read version from .release-please-manifest.json key '${manifest_key}' on ${source}"
            exit 1
          fi

          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            pr_number="${{ github.event.pull_request.number }}"
            version="pr.${pr_number}-sha.${sha_short}"
          elif [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            version="${base}-dev-sha.${sha_short}"
          else
            # Optional: other branches treated as dev builds too
            version="${base}-dev-sha.${sha_short}"
          fi

          echo "Computed base: ${base} (from ${source})"
          echo "version=${version}" | tee -a "${GITHUB_OUTPUT}"

      - id: retrieve-images
        run: | 
          IMAGES=$(docker compose -f compose.build.yaml config --services | tr '\n' ',' | sed 's/,$//' | jq -c -R 'split(",")')
          echo "images=$IMAGES"
          echo "images=$IMAGES" >> "$GITHUB_OUTPUT"

  build-push-easytrade:
    runs-on: ubuntu-24.04
    needs: prepare
    strategy:
      matrix:
        image: ${{ fromJSON(needs.prepare.outputs.images) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Log in to registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: src/${{ matrix.image }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ matrix.image }}:${{ needs.prepare.outputs.version }}
      # - name: Build Docker images (pr event)
      #   id: build-on-pr
      #   shell: bash
      #   if: ${{ github.event_name == 'pull_request' }}
      #   run: |
      #     echo "Building image ${{ matrix.image }} with tag: $TAG"
      #     docker build --push src/${{ matrix.image }} -t ${{ env.REGISTRY }}/${{ matrix.image }}:$TAG --annotation "pr_number=${{ github.event.number }}"
      # - name: Push Docker images
      #   shell: bash
      #   run: |
      #     echo "Pushing images to registry..."
      #     docker push ${{ env.REGISTRY }}/${{ matrix.image }}:$TAG
      #     echo "Successfully pushed all images with tag: $TAG"

  # octopus:
  #   runs-on: ubuntu-24.04
  #   needs: [build-push-easytrade, prepare]
  #   env:
  #     OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_API_KEY  }}
  #     OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
  #     OCTOPUS_SPACE: 'Default'
  #   steps:
  #     - name: Create a release in Octopus Deploy üêô
  #       id: octopus_release 
  #       uses: OctopusDeploy/create-release-action@v4
  #       with:
  #         project: 'easytrade'
  #         git_ref: ${{ github.head_ref || github.ref }}
  #         git_commit: ${{ github.event.after || github.event.pull_request.head.sha }}
  #         package_version: ${{ env.TAG }}